<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner Test</title>
  <style>
    /* 掃描介面的容器樣式，初始隱藏 */
    #scannerContainer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    /* video 視窗尺寸與背景 */
    #scannerVideo {
      width: 300px;
      height: 200px;
      background: #000;
    }
    /* 關閉掃描器按鈕 */
    #closeScannerBtn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #9a9a9a;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* 主頁面上的掃描按鈕 */
    #scanButton {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>QR Code Scanner Demo</h2>
  <!-- 用戶點擊按鈕後啟動掃描 -->
  <button id="scanButton">Scan QR Code</button>
  
  <!-- 掃描介面容器 -->
  <div id="scannerContainer">
    <!-- video 標籤，內嵌播放且已設置必要屬性 -->
    <video id="scannerVideo" autoplay muted playsinline webkit-playsinline></video>
    <!-- canvas 用來抓取 video 畫面影像 (隱藏) -->
    <canvas id="scannerCanvas" style="display:none;"></canvas>
    <!-- 使用者點擊關閉掃描器 -->
    <button id="closeScannerBtn">Close Scanner</button>
  </div>
  
  <!-- 引入 jsQR 外部套件 -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    let videoStream = null;
    let scanIntervalId = null;
    
    // 啟動掃描器的函式
    function startScanner() {
      const scannerContainer = document.getElementById('scannerContainer');
      const video = document.getElementById('scannerVideo');
      const canvas = document.getElementById('scannerCanvas');
      const canvasContext = canvas.getContext('2d');
      
      // 顯示掃描介面
      scannerContainer.style.display = 'flex';
      
      // 嘗試啟動相機 (請確保頁面以 HTTPS 或正式網域開啟)
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.play();
          
          // 當 video 載入完畢後，調整 canvas 尺寸與 video 相同
          video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
          });
          
          // 每隔 500 毫秒檢查一次畫面，嘗試偵測 QR Code
          scanIntervalId = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
              canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
              const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);
              
              if (code) {
                // QR Code 被偵測到，顯示結果並關閉掃描器
                console.log("QR Code detected:", code.data);
                alert("QR Code detected: " + code.data);
                stopScanner();
                scannerContainer.style.display = 'none';
              }
            }
          }, 500);
        })
        .catch(err => {
          console.error("Unable to access camera:", err);
          alert("Unable to access the camera. Please check your permissions.");
          scannerContainer.style.display = 'none';
        });
    }
    
    // 停止掃描器，關閉相機並清除掃描間隔
    function stopScanner() {
      const video = document.getElementById('scannerVideo');
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;
      clearInterval(scanIntervalId);
    }
    
    // 綁定「Scan QR Code」按鈕 (必須由使用者點擊觸發，確保權限提示出現)
    document.getElementById('scanButton').addEventListener('click', function() {
      startScanner();
    });
    
    // 綁定「Close Scanner」按鈕
    document.getElementById('closeScannerBtn').addEventListener('click', function() {
      stopScanner();
      document.getElementById('scannerContainer').style.display = 'none';
    });
  </script>
</body>
</html>
